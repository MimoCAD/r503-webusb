<!doctype html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
        />
        <meta name="theme-color" content="#252830" />
        <meta name="og:sitename" content="MimoCAD" />
        <meta name="og:image" content="/assets/image.png" />
        <meta name="Description" content="Time Clock" />
        <title>Time Clock</title>
        <link
            async
            preload
            rel="stylesheet"
            crossorigin="anonymous"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            href="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        />
        <link
            async
            preload
            rel="stylesheet"
            href="//mimocad.io/static/fa-6.6.0/css/all.css"
        />
        <link
            async
            preload
            rel="stylesheet"
            href="//mimocad.io/static/css/mimocad.css"
        />
        <link
            async
            preload
            rel="stylesheet"
            href="//mimocad.io/static/css/night.css"
        />
    </head>
    <body class="d-flex flex-column h-100">
        <header class="d-print-none">
            <nav class="navbar navbar-expand-lg bg-body-tertiary">
                <div class="container">
                    <a class="navbar-brand" href="/">
                        <img
                            src="/favicon.ico"
                            alt="Logo"
                            width="30"
                            height="30"
                            class="d-inline-block align-text-top"
                        />
                        WebUSB
                    </a>
                    <button
                        class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent"
                        aria-expanded="false"
                        aria-label="Toggle navigation"
                    >
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div
                        class="collapse navbar-collapse"
                        id="navbarSupportedContent"
                    >
                        <ul class="navbar-nav me-auto mb-2 mb-md-0">
                            <li class="nav-item">
                                <a class="nav-link" href="/"
                                    ><i class="fal fa-home fa-fw"></i> Home</a
                                >
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/index.html"
                                    ><i class="fal fa-fingerprint fa-fw"></i>
                                    Timeclock</a
                                >
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <style>
            .container {
                margin-top: -1px;
                margin-bottom: -1px;
            }
            .row {
                margin-bottom: 1.5em;
            }
            .form-control {
                text-align: center;
            }
            #clock {
                text-align: center;
            }
            #clock #time span {
                font-size: 110px;
                width: 160px;
                display: inline-block;
                text-align: center;
                font: monospace;
            }
            #clock #date span {
                font-size: 55px;
                width: 320px;
                display: inline-block;
                text-align: center;
                font: monospace;
            }
        </style>
        <main class="container">
            <div id="clock">
                <span id="time">
                    <span id="hrs">00</span>
                    <span>:</span>
                    <span id="min">00</span>
                    <span>:</span>
                    <span id="sec">00</span>
                </span>
                <br />
                <span id="date">
                    <span id="m">Month</span>
                    <span id="d">Day</span>
                    <span id="y">Year</span>
                </span>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <input
                        class="form-control form-control-lg text-primary"
                        type="text"
                        id="badge"
                    />
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        1
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        2
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        3
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        4
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        5
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        6
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        7
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        8
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        9
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <button class="btn btn-block btn-lg btn-success" id="fpsd">
                        <i class="fa-solid fa-fingerprint"></i>
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-secondary number"
                    >
                        0
                    </button>
                </div>
                <div class="col-sm-4">
                    <button
                        class="btn btn-block btn-lg btn-outline-danger"
                        id="clear"
                    >
                        <i class="fa-regular fa-broom-wide"></i>
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 input-group">
                    <label class="input-group-text" for="inputGroupSelect01"
                        >AuraLEDConfig</label
                    >
                    <select class="form-select" id="pattern">
                        <option value="1">Breathing</option>
                        <option value="2">Flashing</option>
                        <option value="3">AlwaysOn</option>
                        <option value="4">AlwaysOff</option>
                        <option value="5">FadeUpToOff</option>
                        <option value="6">FadeDownToOn</option>
                    </select>
                    <input
                        type="number"
                        min="0"
                        max="255"
                        class="form-control"
                        value="0"
                        id="speed"
                    />
                    <select class="form-select" id="color">
                        <option value="1">Red</option>
                        <option value="2">Blue</option>
                        <option value="3">Purple</option>
                        <option value="4">Green</option>
                        <option value="5">Yellow</option>
                        <option value="6">Cyan</option>
                        <option value="7">White</option>
                    </select>
                    <input
                        type="number"
                        min="0"
                        max="255"
                        class="form-control"
                        value="0"
                        id="times"
                    />
                </div>
            </div>
        </main>
        <footer class="bg-black mt-auto py-3">
            <div class="container text-light" id="footer">&nbsp;</div>
        </footer>
        <script defer>
            "use strict";

            // Time Clock Interface
            setInterval(() => {
                let currentTime = new Date();
                hrs.innerHTML = zeroPad(currentTime.getHours());
                min.innerHTML = zeroPad(currentTime.getMinutes());
                sec.innerHTML = zeroPad(currentTime.getSeconds());
                y.innerHTML = currentTime.getFullYear();
                m.innerHTML = month(currentTime.getMonth());
                d.innerHTML = day(currentTime.getDate());
            }, 1000);
            function zeroPad(int) {
                if (int < 10) return `0${int}`;
                return int;
            }
            const month = (month) => {
                switch (month) {
                    case 0:
                        return "January";
                    case 1:
                        return "Febuary";
                    case 2:
                        return "March";
                    case 3:
                        return "April";
                    case 4:
                        return "May";
                    case 5:
                        return "June";
                    case 6:
                        return "July";
                    case 7:
                        return "August";
                    case 8:
                        return "September";
                    case 9:
                        return "October";
                    case 10:
                        return "November";
                    case 11:
                        return "December";
                }
            };
            function day(day) {
                if (day == 1 || day == 21 || day == 31) return `${day}st`;
                if (day == 2 || day == 22) return `${day}nd`;
                if (day == 3 || day == 23) return `${day}rd`;

                return `${day}th`;
            }

            // Finger Print Keypad UI
            const digits = document.querySelectorAll(".number");
            digits.forEach((digit) => {
                digit.addEventListener("click", (e) => {
                    badge.value += parseInt(e.srcElement.innerText);
                });
            });
            clear.addEventListener("click", () => {
                badge.value = "";
            });

            // WebUSB
            let device = "None";
            fpsd.addEventListener("click", () => {
                navigator.usb
                    .requestDevice({ filters: [{ vendorId: 0x1ee7 }] })
                    .then((selectedDevice) => {
                        device = selectedDevice;
                        fpsd.classList.toggle("btn-success");
                        fpsd.classList.toggle("btn-outline-success");
                        footer.innerHTML = `${selectedDevice.manufacturerName} ${selectedDevice.productName} - ${selectedDevice.serialNumber} Connected`;
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            });
            (async () => {
                console.log("Hello World");

                navigator.usb.addEventListener("connect", (event) => {
                    console.log(
                        `USB Connect: ${event.device.productName}, serial number ${event.device.serialNumber}`,
                    );
                });

                navigator.usb
                    .getDevices({ filters: [{ vendorId: 0x1ee7 }] })
                    .then((devices) => {
                        console.log(`Total devices: ${devices.length}`);
                        devices.forEach(async (eachDevice) => {
                            console.log(
                                `Product name: ${eachDevice.productName}, serial number ${eachDevice.serialNumber}`,
                            );
                            await eachDevice.open();
                            console.log("Opened");
                            await eachDevice.selectConfiguration(1);
                            console.log("Configured");
                            await eachDevice.claimInterface(1);
                            console.log("Claimed");
                            device = eachDevice;
                            getRandomCode();
                            await usbRead();
                            fpsd.classList.toggle("btn-success");
                            fpsd.classList.toggle("btn-outline-success");
                            footer.innerHTML = `${device.manufacturerName} ${device.productName} - ${device.serialNumber} Connected`;
                        });
                    });
            })();

            pattern.addEventListener("change", () => {
                console.log(`Pattern Update ${pattern.value}`);
                auraLEDConfig(
                    pattern.value,
                    speed.value,
                    color.value,
                    times.value,
                );
            });
            speed.addEventListener("change", () => {
                console.log(`Speed Update ${speed.value}`);
                auraLEDConfig(
                    pattern.value,
                    speed.value,
                    color.value,
                    times.value,
                );
            });
            color.addEventListener("change", () => {
                console.log(`Color Update ${color.value}`);
                auraLEDConfig(
                    pattern.value,
                    speed.value,
                    color.value,
                    times.value,
                );
            });
            times.addEventListener("change", () => {
                console.log(`Times Update ${times.value}`);
                auraLEDConfig(
                    pattern.value,
                    speed.value,
                    color.value,
                    times.value,
                );
            });
            /**
             * @return void
             */
            async function usbRead() {
                let usbRead = await device.transferIn(1, 64);
                console.log(`USBRead | Status: ${usbRead.status};`);
                console.log(`USBRead | Data Len: ${usbRead.data.byteLength}`);
                for (var i = 0; i < usbRead.data.byteLength; i++) {
                    console.log(
                        `USBRead | Data[${i}]: ${usbRead.data.getUint8(i)}`,
                    );
                }
            }
            /**
             * @param u8 Pattern = 1 = Breathing, 2 = Flashing, 3 = AlwaysOn, 4 = AlwaysOff, 5 = GraduallyOn, 6 = GraduallyOff;
             * @param u8 Speed = 0-255, Higher is Slower.
             * @param u8 Color = 1 = Red, 2 = Blue, 3 = Purple, 4 = Green, 5 = Yellow, 6 = Cyan, White = 7;
             @ @param u8 Times = 0-255; 0 = Inf;
             * @return void
             */
            async function auraLEDConfig(pattern, spd, clr, x) {
                let patrn = parseInt(pattern);
                let speed = parseInt(spd);
                let color = parseInt(clr);
                let times = parseInt(x);
                let cksum = parseInt(61) + patrn + speed + color + times;
                let cs_hi = parseInt(cksum / 256);
                let cs_lo = parseInt(cksum % 256);

                await device.transferOut(
                    1,
                    new Uint8Array([
                        // u16 - Header
                        0xef, // 239
                        0x01, //   1
                        // u32 - Address
                        0xff, // 255
                        0xff, // 255
                        0xff, // 255
                        0xff, // 255
                        //  u8 - Identifier
                        0x01, // 0x01 Command Packet
                        // u16 - Length (Number of bytes after this byte)
                        0x00, //   0 - Always 0, can't send larger than 255 anyway.
                        0x07, //   7 - Data.Instruction = 1; Data.Payload = 4; Checksum = 2; 1 + 4 + 2 = 7
                        // ??? - Data
                        //  u8 - Data.Instruction
                        0x35, //  53 - Aura LED Config.
                        // ??? - Data.Payload
                        patrn, //   ? - Pattern
                        speed, //   ? - Speed
                        color, //   ? - Color
                        times, //   ? - Times
                        // u16 - Checksum (2 Bytes) Sum(Identifier + Len + Data) Bytes.
                        cs_hi, // Dec =   Id |   Length    | Data
                        cs_lo, //  61 = 0x01 + 0x00 + 0x07 + 0x35 + 0x03 + 0x00 + 0x?? + 0x00
                    ]),
                );
                await usbRead();
            }
            async function getRandomCode() {
                await device.transferOut(
                    1,
                    new Uint8Array([
                        // u16 - Header
                        0xef, // 239
                        0x01, //   1
                        // u32 - Address
                        0xff, // 255
                        0xff, // 255
                        0xff, // 255
                        0xff, // 255
                        //  u8 - Identifier
                        0x01, // 0x01 Command Packet
                        // u16 - Length (Number of bytes after this byte)
                        0x00, //   0 - Always 0, can't send larger than 255 anyway.
                        0x03, //   3 - Data.Instruction = 1; Data.Payload = 0; Checksum = 2; 1 + 0 + 2 = 3
                        // ??? - Data
                        //  u8 - Data.Instruction
                        0x14, //  20 - Get Random Code.
                        // ??? - Data.Payload
                        // u16 - Checksum (2 Bytes) Sum(Identifier + Len + Data) Bytes.
                        0x00, //   Id |   Length    | Data
                        0x18, // 0x01 + 0x00 + 0x03 + 0x14
                    ]),
                );
                await usbRead();
            }
        </script>
        <script
            crossorigin="anonymous"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            src="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        ></script>
        <script
            crossorigin="anonymous"
            src="//mimocad.io/static/fa-6.6.0/js/all.js"
        ></script>
    </body>
</html>
